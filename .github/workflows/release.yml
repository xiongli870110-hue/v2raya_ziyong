name: Build and Release v2rayA Bundle

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-v2raya:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Prepare bundle directory
      run: |
        mkdir -p bundle/v2ray-core/systemd/system

    - name: Download v2rayA binary (x64)
      run: |
        wget -O bundle/v2raya_linux_x64_2.2.7.3 https://github.com/v2rayA/v2rayA/releases/download/v2.2.7.3/v2raya_linux_x64_2.2.7.3
        chmod +x bundle/v2raya_linux_x64_2.2.7.3

    - name: Download and extract v2ray-core
      run: |
        wget -O v2ray.zip https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-linux-64.zip
        unzip -o v2ray.zip -d tmp-v2ray
        mkdir -p bundle/v2ray-core
        cp tmp-v2ray/v2ray bundle/v2ray-core/
        cp tmp-v2ray/*.json bundle/v2ray-core/
        cp tmp-v2ray/*.dat bundle/v2ray-core/
        cp -r tmp-v2ray/systemd bundle/v2ray-core/

    - name: Overwrite config.json with DNS disabled
      run: |
        cat <<EOF > bundle/v2ray-core/config.json
        {
          "dns": { "servers": [] },
          "inbounds": [{
            "port": 10808,
            "listen": "127.0.0.1",
            "protocol": "socks",
            "settings": { "auth": "noauth", "udp": true }
          }],
          "outbounds": [{
            "protocol": "freedom",
            "settings": {}
          }]
        }
        EOF

    - name: Add version marker
      run: |
        echo "v2rayA 2.2.7.3 + v2ray-core $(date +%Y%m%d)" > bundle/VERSION.txt

    - name: Package bundle
      run: |
        tar -czvf v2rayA-bundle.tar.gz -C bundle .

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2rayA-bundle-v2.2.7.3
        name: "v2rayA Bundle v2.2.7.3"
        body: |
          ✅ Includes v2rayA x64 binary  
          ✅ Includes v2ray-core binary  
          ✅ Includes geoip.dat and geosite.dat  
          ✅ Includes default config.json (DNS disabled)  
          ✅ Includes systemd templates  
          ✅ Compatible with offline installation script
        files: v2rayA-bundle.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
