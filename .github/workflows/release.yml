name: Package v2rayA + core for offline install

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  bundle:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Download v2rayA binary
      run: |
        mkdir -p v2rayA-bundle
        wget -O v2rayA-bundle/v2raya_linux_x64_2.2.7.3 https://github.com/v2rayA/v2rayA/releases/download/v2.2.7.3/v2raya_linux_x64_2.2.7.3

    - name: Download and extract v2ray-core
      run: |
        mkdir -p v2rayA-bundle/v2ray-core
        wget -O v2ray-core.zip https://github.com/v2fly/v2ray-core/releases/download/v5.41.0/v2ray-linux-64.zip
        unzip -q v2ray-core.zip -d v2rayA-bundle/v2ray-core

    - name: Add install script
      run: |
        cat > v2rayA-bundle/install-v2raya-full.sh <<'EOF'
        #!/bin/bash
        set -e
        echo "[v2raya-install] 开始安装 v2rayA + v2ray-core..."
        BIN_DIR=/usr/local/bin
        SHARE_DIR=/usr/local/share/v2ray
        mkdir -p "$BIN_DIR" "$SHARE_DIR"
        install -Dm755 ./v2raya_linux_x64_2.2.7.3 "$BIN_DIR/v2rayA"
        install -Dm755 ./v2ray-core/v2ray "$BIN_DIR/v2ray"
        for f in ./v2ray-core/*.dat; do
          install -Dm644 "$f" "$SHARE_DIR/$(basename "$f")"
        done
        echo "[v2raya-install] 安装完成 ✅"
        EOF
        chmod +x v2rayA-bundle/install-v2raya-full.sh

    - name: Package everything into one tar.gz
      run: |
        tar -czvf v2rayA-bundle.tar.gz -C v2rayA-bundle .

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2rayA-bundle-v2.2.7.3
        name: "v2rayA 离线安装包 v2.2.7.3"
        body: |
          ✅ 包含 v2rayA v2.2.7.3 二进制  
          ✅ 包含 v2ray-core v5.41.0 主程序和 dat 文件  
          ✅ 包含 install-v2raya-full.sh 一键安装脚本  
          ✅ 适用于无法联网的 Linux 系统（QNAP、Ubuntu、Debian 等）
        files: v2rayA-bundle.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
