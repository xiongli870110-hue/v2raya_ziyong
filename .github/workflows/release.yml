name: 构建 v2rayA 合成版本包

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 安装依赖
        run: |
          sudo apt update
          sudo apt install -y curl wget jq unzip

      - name: 下载 v2ray-core（排除 .dgst）
        run: |
          CORE_URL=$(curl -s https://api.github.com/repos/v2fly/v2ray-core/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux-64.zip$")) | .browser_download_url')
          echo "v2ray-core 下载链接：$CORE_URL"
          curl -L "$CORE_URL" -o v2ray-core.zip
          unzip v2ray-core.zip -d bundle/v2ray-core
          chmod +x bundle/v2ray-core/v2ray

      - name: 下载 v2rayA（排除 .dgst）
        run: |
          V2RAYA_URL=$(curl -s https://api.github.com/repos/mzz2017/v2rayA/releases/latest \
            | jq -r '.assets[] | select(.name | test("linux-amd64.tar.gz$")) | .browser_download_url')
          echo "v2rayA 下载链接：$V2RAYA_URL"
          curl -L "$V2RAYA_URL" -o v2raya.tar.gz
          mkdir -p bundle/v2rayA
          tar -xzf v2raya.tar.gz -C bundle/v2rayA
          chmod +x bundle/v2raya/v2rayA || chmod +x bundle/v2rayA/v2rayA

      - name: 打包为 tar.gz
        run: |
          tar -czvf v2rayA-bundle.tar.gz bundle/

      - name: 发布到 GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          files: v2rayA-bundle.tar.gz




        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
