name: Build and Release for v2rayA Bundle

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-v2raya:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build v2rayA Bundle inside Ubuntu 16.04 container
      run: |
        docker run --rm -v $PWD:/build -w /build ubuntu:16.04 bash -c "
          set -e
          apt update &&
          DEBIAN_FRONTEND=noninteractive apt install -y \
            curl wget unzip jq ca-certificates &&
          
          mkdir -p /build/output/v2ray-core &&
          mkdir -p /build/output/v2rayA &&

          echo 'ğŸ“¥ ä¸‹è½½ v2ray-core...' &&
          CORE_URL=\$(curl -s https://api.github.com/repos/v2fly/v2ray-core/releases/latest | jq -r '.assets[] | select(.name | test(\"linux-64.zip$\")) | .browser_download_url') &&
          curl -L \$CORE_URL -o v2ray-core.zip &&
          unzip v2ray-core.zip -d /build/output/v2ray-core &&
          chmod +x /build/output/v2ray-core/v2ray &&

          echo 'ğŸ“¥ ä¸‹è½½ v2rayA...' &&
          curl -L https://github.com/v2rayA/v2rayA/releases/download/v2.2.7.3/v2raya_linux_x64_2.2.7.3 -o /build/output/v2rayA/v2rayA &&
          chmod +x /build/output/v2rayA/v2rayA
        "

    - name: List output contents before packaging
      run: |
        echo "ğŸ“ æ‰“åŒ…å‰çš„å†…å®¹ï¼š"
        ls -lR output

    - name: Package build output (ä¿ç•™ç›®å½•ç»“æ„)
      run: |
        tar -czvf v2rayA-bundle.tar.gz output/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2rayA-bundle-v2.2.7.3
        name: "v2rayA åˆæˆç‰ˆæœ¬ v2.2.7.3"
        body: |
          âœ… åŒ…å« v2ray-core æœ€æ–°ç‰ˆæœ¬ï¼ˆè‡ªåŠ¨è·å–ï¼‰  
          âœ… åŒ…å« v2rayA v2.2.7.3ï¼ˆé™æ€äºŒè¿›åˆ¶ï¼‰  
          âœ… é€‚ç”¨äº QNAPã€Ubuntuã€Debian ç­‰ç³»ç»Ÿ  
          âœ… æ— éœ€ systemdï¼Œé€‚åˆè‡ªå®šä¹‰é›†æˆéƒ¨ç½²
        files: v2rayA-bundle.tar.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GH_PAT }}
